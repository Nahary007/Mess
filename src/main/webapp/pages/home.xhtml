<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"
        >
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xml:lang="fr" lang="fr">

<h:head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Messagerie</title>
    <link rel="stylesheet" href="../ressources/css/chat.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</h:head>

<h:body>
    <div class="app-container">

        <!-- ===== SIDEBAR GAUCHE ===== -->
        <aside class="sidebar left">
            <div class="search-section">
                <div class="search-wrapper">
                    <img src="../ressources/assets/logo.png" alt="Logo" class="logo-site" />

                    <h:form id="searchForm">
                        <div class="input-container">
                            <i class="fas fa-search search-icon"></i>

                            <h:inputText value="#{chatBean.query}" id="searchInput" styleClass="search-input">
                                <f:ajax event="keyup" render="searchDropdown" listener="#{chatBean.searchEtudiants}" execute="searchInput" />
                            </h:inputText>

                            <h:panelGroup id="searchDropdown" layout="block" styleClass="dropdown">
                                <ul>
                                    <ui:repeat value="#{chatBean.resultatsRecherche}" var="etudiant">
                                        <li>
                                            <!-- Changement : Utilise f:setPropertyActionListener + f:ajax pour AJAX sans navigation -->
                                            <h:commandLink value="#{etudiant.nom} (#{etudiant.email})" style="display: block; text-decoration: none;">
                                                <f:setPropertyActionListener target="#{chatBean.emailDestinataire}" value="#{etudiant.email}" />
                                                <f:ajax event="action" listener="#{chatBean.ouvrirConversation}" render="chatHeader chatBody chatFooter" execute="@this" />
                                            </h:commandLink>
                                        </li>
                                    </ui:repeat>
                                </ul>
                            </h:panelGroup>
                        </div>
                    </h:form>

                </div>
            </div>

            <!-- Changement : Liste dynamique des contacts via ui:repeat -->
            <!-- Dans <aside class="sidebar left">, remplacez la div contacts par : -->
            <div class="contacts">
                <!-- MODIF: ui:repeat sur summaries avec var="summary" -->
                <ui:repeat value="#{chatBean.conversationSummaries}" var="summary">
                    <h:commandLink styleClass="contact" style="text-decoration: none; display: block;">
                        <f:setPropertyActionListener target="#{chatBean.emailDestinataire}" value="#{summary.otherEmail}" />
                        <f:ajax event="action" listener="#{chatBean.ouvrirConversation}" render="chatHeader chatBody chatFooter" execute="@this" />
<!--                        <img src="" alt="avatar" />-->
                        <div class="contact-info">
                            <p class="name">#{summary.otherNom}</p>
                            <p class="last-msg">#{summary.lastMsg}</p>
                        </div>
                    </h:commandLink>
                </ui:repeat>
            </div>

            <div class="logout-section">
                <h:form>
                    <h:commandButton value="D√©connexion" action="#{authBean.logout}" styleClass="logout-btn" />
                </h:form>
            </div>

        </aside>

        <!-- ===== ZONE CENTRALE ===== -->
        <main class="chat" id="chatMain">  <!-- Ajout id pour naming container -->
            <!-- Changement : rendered conditionnel + contenu dynamique -->
            <div class="chat-header" id="chatHeader" rendered="#{chatBean.conversation != null}">
<!--                <h:graphicImage value="#{chatBean.destinataire.avatar}" alt="avatar" styleClass="avatar-header" />-->
                <h:outputText value="#{chatBean.destinataire.nom}" id="chatName" />
            </div>

            <div class="chat-body" id="chatBody">
                <!-- Changement : ui:repeat pour messages, conditionnel pour empty -->
                <ui:repeat value="#{chatBean.historique}" var="msg" rendered="#{chatBean.conversation != null}">
                    <div class="message #{msg.expediteur.email eq authController.etudiantConnecte.email ? 'sent' : 'received'}">
                        <span>#{msg.contenu}</span>
                        <small style="display: block; font-size: 0.8em; color: gray;">#{msg.timestamp}</small>  <!-- Assumant un champ timestamp -->
                    </div>
                </ui:repeat>
                <p class="empty" rendered="#{chatBean.conversation == null}">S√©lectionnez un contact pour d√©marrer une conversation</p>
            </div>

            <!-- Changement : Formulaire JSF pour envoi, rendered conditionnel -->
            <div class="chat-footer" id="chatFooter" rendered="#{chatBean.conversation != null}">
                <button class="add-btn" type="button">+</button>
                <h:form id="messageForm">
                    <h:inputTextarea id="messageInput" value="#{chatBean.nouveauMessage}" placeholder="√âcrire un message..." styleClass="message-input" />
                    <h:commandButton styleClass="send-btn" type="submit">
                        <f:ajax event="action" listener="#{chatBean.envoyerMessage}" render="chatBody" execute="messageInput" onevent="scrollToBottom" />
                        <i class="fas fa-paper-plane"></i>  <!-- Ic√¥ne au lieu de texte -->
                    </h:commandButton>
                </h:form>
            </div>
        </main>

        <!-- ===== SIDEBAR DROITE ===== (inchang√©e) -->
        <aside class="sidebar right">
            <div class="search-section">
                <div class="search-wrapper">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" placeholder="Rechercher..." />
                    <div class="dropdown">
                        <ul>
                            <li>Historique 1</li>
                            <li>Historique 2</li>
                            <li>Historique 3</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="groups">
                <div class="group">
                    <p class="group-name">Groupe D√©v Web</p>
                </div>
                <div class="group">
                    <p class="group-name">Famille üë®‚Äçüë©‚Äçüëß‚Äçüë¶</p>
                </div>
            </div>
        </aside>
    </div>

    <!-- ===== POPUP CREATION GROUPE ===== (inchang√©e) -->
    <div class="popup-overlay hidden" id="groupPopup">
        <div class="popup">
            <h2>Cr√©er un groupe</h2>
            <input type="text" placeholder="Nom du groupe" id="groupName" />
            <button id="createGroup" type="button">Cr√©er</button>
            <button id="closePopup" type="button">Annuler</button>
        </div>
    </div>

    <script type="text/javascript" src="../ressources/js/script.js"></script>
</h:body>
</html>