<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://java.sun.com/jsf/facelets">
<h:head>
    <title>Chat de Groupe</title>
    <style>
        .layout { display: flex; height: 100vh; }
        .left-sidebar { width: 20%; background-color: #f4f4f4; padding: 10px; overflow-y: auto; }
        .center { width: 60%; background-color: white; display: flex; flex-direction: column; }
        .right-sidebar { width: 20%; background-color: #f4f4f4; padding: 10px; overflow-y: auto; }
        .chat-header { display: flex; justify-content: space-between; align-items: center; padding: 10px; background-color: #e0e0e0; border-bottom: 1px solid #ccc; }
        .chat-body { flex: 1; overflow-y: auto; padding: 10px; }
        .chat-footer { display: flex; padding: 10px; border-top: 1px solid #ccc; }
        .chat-footer p:inputTextarea { flex: 1; margin-right: 10px; }
        .invitation-item { border: 1px solid #ddd; margin-bottom: 10px; padding: 10px; }
    </style>
</h:head>
<h:body>
    <div class="layout">
        <!-- Sidebar gauche : Liste des groupes -->
        <div class="left-sidebar">
            <h:form>
                <p:commandButton value="Créer groupe" type="button" onclick="PF('createGroupDlg').show()" style="width: 100%; margin-bottom: 10px;" />

                <p:dialog header="Créer un nouveau groupe" widgetVar="createGroupDlg" modal="true" resizable="false">
                    <p:panel>
                        <p:outputLabel for="nomGroupe" value="Nom du groupe :" />
                        <p:inputText id="nomGroupe" value="#{groupeBean.nomGroupe}" required="true" />
                        <p:commandButton value="Créer" action="#{groupeBean.creerGroupe}" update=":groupsForm:groupsTable :centerForm:centerPanel"
                                         oncomplete="PF('createGroupDlg').hide(); #{groupeBean.nomGroupe = ''}" />
                    </p:panel>
                </p:dialog>

                <p:dataTable id="groupsTable" value="#{groupeBean.groupes}" var="groupe" emptyMessage="Aucun groupe">
                    <p:column headerText="Groupes">
                        <p:commandLink value="#{groupe.nom}" action="#{chatBean.ouvrirConversationGroupe(groupe.id)}"
                                       update=":centerForm:centerPanel" style="display: block; text-decoration: none;" />
                    </p:column>
                </p:dataTable>
            </h:form>
        </div>

        <!-- Contenu central : Chat ouvert -->
        <div class="center">
            <h:form id="centerForm">
                <p:panelGroup id="centerPanel" layout="block">
                    <ui:fragment rendered="#{chatBean.conversation != null}">
                        <!-- Header du chat -->
                        <div class="chat-header">
                            <h:outputText value="#{chatBean.conversation.nom}" style="font-weight: bold;" />
                            <p:commandButton icon="pi pi-plus" type="button" onclick="PF('inviteDlg').show()" />
                        </div>

                        <!-- Popup d'invitation -->
                        <p:dialog header="Inviter des membres au groupe" widgetVar="inviteDlg" modal="true" resizable="false">
                            <h:form id="inviteForm">
                                <p:inputText value="#{chatBean.query}" placeholder="Tapez le nom ou l'email..."
                                             style="width: 100%; margin-bottom: 10px;">
                                    <p:ajax event="keyup" listener="#{chatBean.searchEtudiants}" update=":inviteForm:searchResults" delay="300" />
                                </p:inputText>

                                <p:dataTable id="searchResults" value="#{chatBean.resultatsRecherche}" var="etu"
                                             emptyMessage="Aucun utilisateur trouvé" style="width: 100%;">
                                    <p:column headerText="Utilisateur">
                                        <h:outputText value="#{etu.nom} (#{etu.email})" />
                                    </p:column>
                                    <p:column headerText="Action" style="width: 100px;">
                                        <p:commandButton value="Inviter" action="#{groupeBean.inviter(etu.id, chatBean.conversation.id)}"
                                                         update=":inviteForm:searchResults"
                                                         oncomplete="PF('inviteDlg').hide();" />
                                    </p:column>
                                </p:dataTable>
                            </h:form>
                        </p:dialog>

                        <!-- Body : Historique des messages -->
                        <div class="chat-body">
                            <p:dataTable id="historiqueTable" value="#{chatBean.historique}" var="msg" rowStyleClass="#{msg.expediteur.id == chatBean.authController.etudiantConnecte.id ? 'sent' : 'received'}"
                                         styleClass="no-header">
                                <p:column style="width: 100%; text-align: left;">
                                    <div style="margin-bottom: 5px;">
                                        <h:outputText value="#{msg.expediteur.nom}" style="font-weight: bold; color: gray;" />
                                        <h:outputText value=" - #{msg.dateEnvoi}" style="color: gray; font-size: smaller;" />
                                    </div>
                                    <h:outputText value="#{msg.contenu}" style="background-color: #e0e0e0; padding: 5px; border-radius: 5px; display: inline-block;" />
                                </p:column>
                            </p:dataTable>
                            <ui:fragment rendered="#{empty chatBean.historique}">
                                <p>Aucun message dans ce groupe pour le moment.</p>
                            </ui:fragment>
                        </div>

                        <!-- Footer : Champ d'envoi -->
                        <div class="chat-footer">
                            <p:inputTextarea value="#{chatBean.nouveauMessage}" placeholder="Tapez votre message..." rows="2"
                                             style="width: calc(100% - 100px);" />
                            <p:commandButton value="Envoyer" action="#{chatBean.envoyerMessageGroupe}" update="historiqueTable"
                                             process="@this nouveauMessage" />
                        </div>
                    </ui:fragment>
                    <ui:fragment rendered="#{chatBean.conversation == null}">
                        <p style="text-align: center; margin-top: 50px;">Sélectionnez un groupe pour commencer la discussion.</p>
                    </ui:fragment>
                </p:panelGroup>
            </h:form>
        </div>

        <!-- Sidebar droite : Invitations reçues -->
        <div class="right-sidebar">
            <h:form id="invitationsForm">
                <p:dataTable id="invitationsTable" value="#{groupeBean.invitationsRecues}" var="inv"
                             emptyMessage="Aucune invitation en attente" styleClass="invitations-list">
                    <p:column style="width: 100%;">
                        <div class="invitation-item">
                            <h:outputText value="Groupe : #{inv.conversation.nom}" style="font-weight: bold; display: block;" />
                            <h:outputText value="Invité par : #{inv.expediteur.nom}" style="color: gray; display: block;" />
                            <p:commandButton value="Accepter" action="#{groupeBean.accepteerInvitation(inv.id)}"
                                             update="invitationsTable :groupsForm:groupsTable" style="margin-right: 5px;" />
                            <p:commandButton value="Refuser" action="#{groupeBean.refuserInvitation(inv.id)}"
                                             update="invitationsTable" />
                        </div>
                    </p:column>
                </p:dataTable>
            </h:form>
        </div>
    </div>
</h:body>
</html>